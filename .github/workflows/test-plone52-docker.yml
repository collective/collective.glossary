name: "collective.glossary CI"

on:
  push:

jobs:
  test-plone52:
    name: "Backend: Test Plone 5.2"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9']
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-plone52-${{ hashFiles('**/buildout.cfg', '**/requirements.txt') }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libxml2-dev libxslt1-dev zlib1g-dev

      - name: Create buildout configuration for Plone 5.2
        run: |
          cat > buildout.cfg << 'EOF'
          [buildout]
          extends = 
              https://dist.plone.org/release/5.2-latest/versions.cfg
          
          parts = 
              instance
              test
          
          develop = .
          
          [instance]
          recipe = plone.recipe.zope2instance
          user = admin:admin
          http-address = 8080
          eggs =
              Plone
              collective.glossary [test]
          
          [test]
          recipe = zc.recipe.testrunner
          eggs = collective.glossary [test]
          defaults = ['--auto-color', '--auto-progress']
          EOF

      - name: Bootstrap buildout
        run: |
          python -m pip install --upgrade pip
          python -m pip install zc.buildout
          python bootstrap.py || python -c "import urllib.request; exec(urllib.request.urlopen('https://bootstrap.pypa.io/bootstrap-buildout.py').read())"

      - name: Run buildout
        run: |
          bin/buildout -N

      - name: Run tests
        run: |
          bin/test
